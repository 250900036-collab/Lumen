<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emergency App</title>

<style>
body{
margin:0;
font-family:Arial, sans-serif;
background:#12002b;
color:white;
overflow:hidden;
}

/* Fondo part铆culas */
canvas{
position:fixed;
top:0;
left:0;
z-index:-1;
}

/* Fade */
.page{
position:absolute;
width:100%;
height:100%;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
opacity:0;
transition:opacity .6s ease;
}

.page.active{
opacity:1;
}

/* Botones */
button{
padding:15px 25px;
margin:10px;
border:none;
border-radius:30px;
font-size:16px;
cursor:pointer;
}

.red{
background:red;
color:white;
}

.green{
background:#25D366;
color:white;
}
</style>
</head>
<body>

<canvas id="particles"></canvas>

<!-- Registro -->
<div id="registerPage" class="page active">
<h2>Registro</h2>
<input id="nameInput" placeholder="Tu nombre" style="padding:10px;border-radius:10px;border:none;margin:10px;">
<button onclick="saveUser()">Guardar</button>
</div>

<!-- Principal -->
<div id="homePage" class="page">
<h1 id="welcomeText"></h1>
<button class="red" onclick="startRecording()"> Grabar</button>
<button onclick="stopRecording()">Detener</button>
<button class="green" onclick="sendWhatsApp()">WhatsApp</button>
<button onclick="enableMotion()">Activar Sensor 911</button>
</div>

<script>
/* ====== TRANSICIN ====== */
function goTo(page){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.getElementById(page).classList.add('active');
}

/* ====== REGISTRO ====== */
function saveUser(){
let name = document.getElementById("nameInput").value.trim();
if(name===""){
alert("Escribe tu nombre");
return;
}
localStorage.setItem("userName",name);
document.getElementById("welcomeText").innerText="Bienvenido "+name;
goTo("homePage");
}

/* Auto login */
window.onload=function(){
let name=localStorage.getItem("userName");
if(name){
document.getElementById("welcomeText").innerText="Bienvenido "+name;
goTo("homePage");
}
}

/* ====== GRABACIN ====== */
let mediaRecorder;
let audioChunks=[];

async function startRecording(){
try{
const stream=await navigator.mediaDevices.getUserMedia({audio:true});
mediaRecorder=new MediaRecorder(stream);

mediaRecorder.ondataavailable=e=>{
audioChunks.push(e.data);
};

mediaRecorder.onstop=()=>{
const blob=new Blob(audioChunks,{type:'audio/webm'});
audioChunks=[];
console.log("Grabaci贸n lista",blob);
};

mediaRecorder.start();
alert("Grabando...");
}catch(err){
alert("Permite acceso al micr贸fono");
console.error(err);
}
}

function stopRecording(){
if(mediaRecorder && mediaRecorder.state!=="inactive"){
mediaRecorder.stop();
alert("Grabaci贸n detenida");
}
}

/* ====== WHATSAPP ====== */
function sendWhatsApp(){
let mensaje=encodeURIComponent("Necesito ayuda, esta es mi ubicaci贸n.");
let numero="521XXXXXXXXXX"; // CAMBIA POR TU NMERO
window.location.href=`https://wa.me/${numero}?text=${mensaje}`;
}

/* ====== SENSOR 911 ====== */
let shakeThreshold=18;
let lastX,lastY,lastZ;
let canShake=false;

function enableMotion(){

if(typeof DeviceMotionEvent!=="undefined" &&
typeof DeviceMotionEvent.requestPermission==="function"){

DeviceMotionEvent.requestPermission()
.then(response=>{
if(response==="granted"){
canShake=true;
window.addEventListener("devicemotion",detectShake);
alert("Sensor activado");
}
})
.catch(console.error);

}else{
canShake=true;
window.addEventListener("devicemotion",detectShake);
alert("Sensor activado");
}
}

function detectShake(event){
if(!canShake) return;

let acc=event.accelerationIncludingGravity;
if(!acc) return;

if(lastX===undefined){
lastX=acc.x;
lastY=acc.y;
lastZ=acc.z;
return;
}

let deltaX=Math.abs(lastX-acc.x);
let deltaY=Math.abs(lastY-acc.y);
let deltaZ=Math.abs(lastZ-acc.z);

if(deltaX>shakeThreshold || deltaY>shakeThreshold || deltaZ>shakeThreshold){
window.location.href="tel:911";
}

lastX=acc.x;
lastY=acc.y;
lastZ=acc.z;
}

/* ====== PARTCULAS ====== */
const canvas=document.getElementById("particles");
const ctx=canvas.getContext("2d");

canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let particles=[];

for(let i=0;i<80;i++){
particles.push({
x:Math.random()*canvas.width,
y:Math.random()*canvas.height,
radius:Math.random()*3+1,
speed:Math.random()*0.5+0.2
});
}

function animate(){
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.fillStyle="purple";
particles.forEach(p=>{
p.y-=p.speed;
if(p.y<0)p.y=canvas.height;
ctx.beginPath();
ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);
ctx.fill();
});
requestAnimationFrame(animate);
}

animate();
</script>

</body>
</html>
